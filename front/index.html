<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Connect 4</title>
    <link rel="stylesheet" href="connect4_style.css">
</head>

<body>
    <h1>Connect 4</h1>
    <button id="newGame">New Game</button>
    <table id="connect4">
    </table>
    <h2 id="curTurn"></h2>
    <div>
        <label><input type="radio" name="selectedPlayer" value="red" checked>Red Player</label>
        <label><input type="radio" name="selectedPlayer" value="yellow">Yellow Player</label>
    </div>
    <h2 id="status">Incomplete</h2>
</body>

</html>
<script>
    // Initialize variables
    var actions = {
        "start": "http://localhost:8080/gameBoard/start",
        "dropChip": "http://localhost:8080/gameBoard/dropChip",
        "getGameState": "http://localhost:8080/gameBoard/getGameState",
        "gameStatus": "http://localhost:8080/gameStatus",
    };

    document.getElementById('newGame').addEventListener('click', () => startGame());

    async function startGame() {
        console.log("starting");
        let gameData = await fetch(actions['start'])
            .then(response => response.json())
            .then(v => {
                updateGameBoard(v);
                updateGameStatus("new game", v.curPlayer, v.winner);
            });
    }

    async function updateGameStatus(status, curPlayerNum, winnerNum) {
        document.getElementById("status").innerHTML = status;
        console.log("in update status");
        await fetch(actions['gameStatus'] + '?status=' + status + '&curPlayerNum=' + curPlayerNum + '&winnerNum=' + winnerNum)
            .then(response => response.json())
            .then(data => console.log("Status updated:", data));
    }

    // Create the table structure in HTML
    function updateGameBoard(gameData) {
        updateCurTurnText(gameData.curPlayer);
        
        const boardElement = document.getElementById('connect4');
        boardElement.innerHTML = '';
        gameData.board.forEach((row, rowIndex) => {
            const tr = document.createElement('tr');
            row.forEach((cell, colIndex) => {
                const td = document.createElement('td');
                if (cell === 0) {
                    td.classList.add('red');
                } else if (cell === 1) {
                    td.classList.add('yellow');
                }
                td.addEventListener('click', () => dropChip(colIndex)); // Make a move on click
                tr.appendChild(td);
            });
            boardElement.appendChild(tr);
        });
       // alertWinner(gameData.winner);
    }

    function alertWinner(winnerNum){
        if(winnerNum != -1){
            let curPlayerString = (winnerNum == 0) ? "red" : "yellow";
            updateGameStatus("${curPlayerString} wins!", winnerNum, winnerNum);
            alert(`${curPlayerString} wins!`);
            startGame();
        }
    }
    function updateCurTurnText(curPlayer) {
        const curPlayerElement = document.getElementById('curTurn');
        let curPlayerString = (curPlayer == 0) ? "red" : "yellow";
        curPlayerElement.innerHTML = "Current Turn: " + curPlayerString;

    }

    async function dropChip(col) {
        const selectedPlayer = document.querySelector('input[name="selectedPlayer"]:checked').value;

        console.log(selectedPlayer);
        let promise = await fetch(actions['dropChip'] + '?col=' + col + '&selectedPlayer=' + selectedPlayer)
            .then(response => response.json())
            .then(response => {
                updateGameBoard(response);
                setTimeout(() => {
                    alertWinner(response.winner);
                }, 100);
            }
            );
    }

    

   /* async function updateStatus(response){
        // curPlayer is 0 (yellow) and 1 (red) here
        let promise = await fetch(actions['checkWin'] + '?board' + board)

    }*/

    setInterval(async () => {
        console.log("Fetching latest game state...");
        let gameData = await fetch(actions['getGameState']) // You might want to change this endpoint if needed
            .then(response => response.json());
        updateGameBoard(gameData);  // Pass the fetched data to the update function
    }, 1000);
    
    /*
        for (let row = 0; row < rows; row++) {
            const tr = document.createElement('tr');
            for (let col = 0; col < cols; col++) {
                const td = document.createElement('td');
                td.setAttribute('id', `${row}-${col}`);
                td.addEventListener('click', () => dropPiece(col));  // Handle clicks
                tr.appendChild(td);
            }
            table.appendChild(tr);
        }
    */

    // Function to drop a piece in the selected column
    /*
    function dropPiece(col) {
        for (let row = rows - 1; row >= 0; row--) {  // Start from the bottom
            if (board[row][col] === '') {
                board[row][col] = currentPlayer;
                document.getElementById(`${row}-${col}`).classList.add(currentPlayer);  // Color the piece
                if (checkWin(row, col)) {
                    alert(`${currentPlayer.toUpperCase()} wins!`);
                    resetGame();
                }
               // currentPlayer = currentPlayer === 'red' ? 'yellow' : 'red';  // Switch player
                break;
            }
        }
    }
    
    // Function to check if there's a winning combination
    function checkWin(row, col) {
        return checkDirection(row, col, 1, 0) ||  // Horizontal
               checkDirection(row, col, 0, 1) ||  // Vertical
               checkDirection(row, col, 1, 1) ||  // Diagonal right-down
               checkDirection(row, col, 1, -1);   // Diagonal left-down
    }
    
    // Check a specific direction for four consecutive pieces
    function checkDirection(row, col, rowDir, colDir) {
        let count = 0;
        for (let i = -3; i <= 3; i++) {
            const r = row + i * rowDir;
            const c = col + i * colDir;
            if (r >= 0 && r < rows && c >= 0 && c < cols && board[r][c] === currentPlayer) {
                count++;
                if (count === 4) return true;
            } else {
                count = 0;
            }
        }
        return false;
    }
    
    // Reset the game board
    function resetGame() {
        board = Array(rows).fill().map(() => Array(cols).fill(''));
        const cells = document.querySelectorAll('td');
        cells.forEach(cell => cell.classList.remove('red', 'yellow'));
    }
    
    // Initialize the game
    */
</script>